# CI Workflow for FenixCRM
# Task 1.1: Project Setup + Complexity gate added post Task 1.3
# Following implementation plan exactly - Section 6 (Testing Strategy)

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Cyclomatic Complexity Gate — blocks merge if any function exceeds threshold 7
  # This job must pass before lint and tests can run.
  complexity:
    name: Complexity Gate (max 7)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check cyclomatic complexity
        # Scans only production code (*_test.go excluded — tests legitimately have more branches).
        # gocyclo exits with code 1 when violations found — causes this step to fail, blocking merge.
        # Threshold 7: industry standard for maintainable, testable functions.
        run: |
          set -euo pipefail
          echo "=== Cyclomatic Complexity Report (threshold: 7, production code only) ==="

          # Use xargs + null delimiters to pass files correctly to gocyclo.
          # This avoids treating all files as a single path (which can cause false PASS).
          VIOLATIONS=$(find ./internal -name '*.go' ! -name '*_test.go' -print0 \
            | xargs -0 gocyclo -over 7 \
            | grep -v "^Average:" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "$VIOLATIONS"
            echo ""
            echo "FAILED: functions above threshold 7 found — refactor before merging"
            exit 1
          else
            echo "PASSED: all production functions at or below threshold 7"
          fi

  traceability:
    name: Traceability Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Create venv and install Doorstop
        run: |
          python -m venv .venv
          ./.venv/bin/pip install --upgrade pip
          ./.venv/bin/pip install doorstop

      - name: Doorstop integrity check
        run: make doorstop-check

      - name: FR-to-test traceability check
        run: make trace-check

  # Job 2: Lint, Test, Build — only runs if complexity gate passes
  test:
    name: Lint and Test
    needs: [complexity, traceability]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install golangci-lint
        run: |
          # v1.55.2 is not compatible with Go 1.24 typecheck in this project.
          # Keep linter version aligned with current Go toolchain used in CI.
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8

      - name: Show lint gates (gocognit + maintidx)
        run: |
          set -euo pipefail
          echo "golangci-lint version:"
          golangci-lint --version
          echo ""
          echo "Configured gates in .golangci.yml:"
          grep -En "gocognit|maintidx" .golangci.yml
          echo ""
          echo "Installed linters (filtered):"
          golangci-lint linters | grep -Ei "gocognit|maintidx"

      - name: Gate gocognit (explicit)
        run: golangci-lint run --new-from-rev=HEAD~1 --enable-only=gocognit ./...

      - name: Gate maintidx (explicit)
        run: golangci-lint run --new-from-rev=HEAD~1 --enable-only=maintidx ./...

      - name: Run linter
        run: golangci-lint run --new-from-rev=HEAD~1 ./...

      - name: Run tests
        run: make test

      - name: Race stability gate
        run: make race-stability

      - name: Global coverage gate
        run: COVERAGE_MIN=79 make coverage-gate

      - name: App coverage gate
        run: COVERAGE_APP_MIN=79 make coverage-app-gate

      - name: TDD coverage gate
        run: TDD_COVERAGE_MIN=79 make coverage-tdd

      - name: Build binary
        run: make build

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  # Job 3: E2E Tests (requires build)
  e2e:
    name: E2E Tests
    needs: [test, contract]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect E2E project
        id: e2e_check
        run: |
          if [ -f tests/e2e/package-lock.json ] && [ -f tests/e2e/package.json ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip E2E (project not present yet)
        if: steps.e2e_check.outputs.enabled != 'true'
        run: |
          echo "Skipping E2E job because tests/e2e/package.json or tests/e2e/package-lock.json was not found."

      - name: Setup Go
        if: steps.e2e_check.outputs.enabled == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        if: steps.e2e_check.outputs.enabled == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json

      - name: Build binary
        if: steps.e2e_check.outputs.enabled == 'true'
        run: make build

      - name: Install E2E dependencies
        if: steps.e2e_check.outputs.enabled == 'true'
        run: |
          cd tests/e2e
          npm ci

      - name: Run E2E tests
        if: steps.e2e_check.outputs.enabled == 'true'
        run: make test-e2e

      - name: Upload E2E results
        if: always() && steps.e2e_check.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: tests/e2e/test-results/

  contract:
    name: API Contract Tests
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Create venv and install Schemathesis + Doorstop
        run: |
          python -m venv .venv
          ./.venv/bin/pip install --upgrade pip
          ./.venv/bin/pip install schemathesis doorstop

      - name: Run contract tests
        run: make contract-test
