# CI Workflow for FenixCRM
# Task 1.1: Project Setup + Complexity gate added post Task 1.3
# Following implementation plan exactly - Section 6 (Testing Strategy)

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Cyclomatic Complexity Gate — blocks merge if any function exceeds threshold 7
  # This job must pass before lint and tests can run.
  complexity:
    name: Complexity Gate (max 7)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check cyclomatic complexity
        # Scans only production code (*_test.go excluded — tests legitimately have more branches).
        # gocyclo exits with code 1 when violations found — causes this step to fail, blocking merge.
        # Threshold 7: industry standard for maintainable, testable functions.
        run: |
          echo "=== Cyclomatic Complexity Report (threshold: 7, production code only) ==="
          PROD_FILES=$(find ./internal -name '*.go' ! -name '*_test.go' | tr '\n' ' ')
          VIOLATIONS=$(gocyclo -over 7 $PROD_FILES | grep -v "^Average:")
          if [ -n "$VIOLATIONS" ]; then
            echo "$VIOLATIONS"
            echo ""
            echo "FAILED: functions above threshold 7 found — refactor before merging"
            exit 1
          else
            echo "PASSED: all production functions at or below threshold 7"
          fi

  # Job 2: Lint, Test, Build — only runs if complexity gate passes
  test:
    name: Lint and Test
    needs: complexity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run linter
        run: make lint

      - name: Run tests
        run: make test

      - name: Build binary
        run: make build

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  # Job 3: E2E Tests (requires build)
  e2e:
    name: E2E Tests
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json

      - name: Build binary
        run: make build

      - name: Install E2E dependencies
        run: |
          cd tests/e2e
          npm ci

      - name: Run E2E tests
        run: make test-e2e

      - name: Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: tests/e2e/test-results/
